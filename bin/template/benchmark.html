<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>åç¨‹å¼ HTTP æµ‹è¯•é¢æ¿</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2em auto;
      max-width: 800px;
      background: #f9fafb;
      color: #333;
    }
    input, textarea, button, select {
      padding: 8px;
      margin: 4px 0;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background: #4f46e5;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #4338ca;
    }
    pre {
      background: #e2e8f0;
      padding: 10px;
      white-space: pre-wrap;
      border-radius: 4px;
    }
    h2 {
      margin-top: 1.5em;
      border-bottom: 1px solid #cbd5e1;
      padding-bottom: 0.3em;
    }
  </style>
</head>
<body>
  <h1>åç¨‹å¼ HTTP æµ‹è¯•é¢æ¿</h1>

  <h2>åŠŸèƒ½æµ‹è¯•</h2>
  <label>URL</label>
  <input id="url" type="text" value="http://localhost:39000/ping" />

  <label>æ–¹æ³•</label>
  <label><input type="radio" name="method" value="GET" checked> GET</label>
  <label><input type="radio" name="method" value="POST"> POST</label>

  <label>è¯·æ±‚ä½“ï¼ˆJSONï¼Œä»… POSTï¼‰</label>
  <textarea id="body" rows="4">{ "msg": "hello" }</textarea>

  <button onclick="sendRequest()">å‘é€è¯·æ±‚</button>

  <pre id="output">ç­‰å¾…è¯·æ±‚...</pre>

  <h2>å‹åŠ›æµ‹è¯•</h2>
  <label>å¹¶å‘æ•°</label>
  <input id="concurrency" type="number" value="10" min="1" />

  <label>æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰</label>
  <input id="duration" type="number" value="5" min="1" />

  <button onclick="startBenchmark()">å¼€å§‹å‹æµ‹</button>

  <pre id="benchResult">ç­‰å¾…å¼€å§‹å‹æµ‹...</pre>

  <script>
    async function sendRequest() {
      const url = document.getElementById("url").value.trim();
      const method = document.querySelector('input[name="method"]:checked').value;
      const bodyInput = document.getElementById("body").value.trim();
      const output = document.getElementById("output");

      const options = {
        method,
        headers: {},
      };

      if (method === "POST") {
        try {
          JSON.parse(bodyInput); // éªŒè¯åˆæ³• JSON
          options.headers["Content-Type"] = "application/json";
          options.body = bodyInput;
        } catch (e) {
          output.innerText = "âŒ è¯·æ±‚ä½“ä¸æ˜¯åˆæ³• JSON";
          return;
        }
      }

      const start = performance.now();
      try {
        const res = await fetch(url, options);
        const elapsed = (performance.now() - start).toFixed(2);
        const text = await res.text();
        let json;
        try {
          json = JSON.stringify(JSON.parse(text), null, 2);
        } catch (e) {
          json = text;
        }

        output.innerText = `âœ… çŠ¶æ€: ${res.status} ${res.statusText}\nâ±ï¸ è€—æ—¶: ${elapsed} ms\nğŸ“¦ å“åº”:\n${json}`;
      } catch (err) {
        output.innerText = `âŒ è¯·æ±‚å¤±è´¥: ${err.message}`;
      }
    }

    async function startBenchmark() {
      const url = document.getElementById("url").value.trim();
      const concurrency = parseInt(document.getElementById("concurrency").value);
      const duration = parseInt(document.getElementById("duration").value) * 1000;
      const benchResult = document.getElementById("benchResult");

      let totalRequests = 0;
      let failedRequests = 0;

      const endTime = Date.now() + duration;

      const worker = async () => {
        while (Date.now() < endTime) {
          try {
            const res = await fetch(url);
            if (!res.ok) failedRequests++;
            totalRequests++;
          } catch {
            failedRequests++;
            totalRequests++;
          }
        }
      };

      const start = Date.now();
      const workers = Array.from({ length: concurrency }, () => worker());
      await Promise.all(workers);
      const elapsed = (Date.now() - start) / 1000;

      const qps = (totalRequests / elapsed).toFixed(2);
      benchResult.innerText =
        `ğŸš€ å‹æµ‹å®Œæˆ\n` +
        `å¹¶å‘æ•°: ${concurrency}\næŒç»­æ—¶é—´: ${elapsed.toFixed(1)} ç§’\n` +
        `æ€»è¯·æ±‚: ${totalRequests}\nå¤±è´¥: ${failedRequests}\n` +
        `QPS: ${qps}`;
    }
  </script>
</body>
</html>
